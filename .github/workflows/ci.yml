name: Build and Test

on:
  push:
    branches:
      - main

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

  build:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: moa_db
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: 11
          distribution: "adopt"

      - name: Login to Docker Hub
        run: docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Start MySQL Service
        run: |
          docker run -d --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -e MYSQL_DATABASE=moa_db mysql:8 && sleep 20
          docker ps -a
          docker inspect --format '{{.State.Status}}' mysql
          docker inspect --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' mysql

      - name: Check MySQL Container Status
        run: docker inspect --format '{{.State.Status}}' mysql

      - name: Check IP
        run: docker inspect --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' mysql

      - name: Print MySQL Logs
        run: docker logs mysql

      - name: Make gradlew script executable
        run: cd backend && chmod +x gradlew

      - name: Wait for MySQL to be ready
        run: docker run --network=host -v $(pwd):/app -w /app vishnubob/wait-for-it -t 0 172.17.0.2:3306

      - name: Run Unit Tests
        run: cd backend && ./gradlew test
